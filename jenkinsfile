pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['apply', 'destroy'],
            description: 'apply = create infra, destroy = delete infra'
        )
    }

    environment {
        AWS_DEFAULT_REGION = 'ap-south-1'
        ANSIBLE_CONFIG = 'ansible/ansible.cfg'
        SSH_KEY = '/var/lib/jenkins/.ssh/jenkinskeylinux16dec.pem'
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Apply / Destroy') {
            steps {
                dir('terraform') {
                    sh '''
                    if [ "$ACTION" = "destroy" ]; then
                        echo "Destroying infrastructure..."
                        terraform destroy -auto-approve
                        exit 0
                    else
                        echo "Applying infrastructure..."
                        terraform apply -auto-approve
                    fi
                    '''
                }
            }
        }

        stage('Wait for EC2 SSH (Ansible Native)') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir('ansible') {
                    sh '''
                    echo "Inventory check:"
                    ansible-inventory -i inventory/aws_ec2.yaml --graph

                    echo "Waiting for SSH using Ansible (no nc required)..."
                    ansible env_dev \
                      -i inventory/aws_ec2.yaml \
                      -u ubuntu \
                      --private-key=$SSH_KEY \
                      -m wait_for_connection \
                      -a "timeout=300"
                    '''
                }
            }
        }

        stage('Ansible Configuration') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir('ansible') {
                    sh '''
                    echo "Running Ansible playbook on env_dev only"
                    ansible-playbook \
                      -i inventory/aws_ec2.yaml \
                      -l env_dev \
                      -u ubuntu \
                      --private-key=$SSH_KEY \
                      playbooks/site.yaml
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ PIPELINE COMPLETED SUCCESSFULLY"
        }
        failure {
            echo "❌ PIPELINE FAILED – Check logs"
        }
    }
}
